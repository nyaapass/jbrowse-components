import { Instance, types } from 'mobx-state-tree'

import BaseViewModel from '@jbrowse/core/pluggableElementTypes/models/BaseViewModel'
import PluginManager from '@jbrowse/core/PluginManager'
import { ElementId } from '@jbrowse/core/util/types/mst'
import { parse } from 'clustal-js'
import * as d3 from 'd3'
import parseNewick from './parseNewick'

const temptree =
  '(EPI_ISL_406798|Wuhan/WH01/2019|Dec26:5015528,EPI_ISL_462283|Singapore/165/2020|Jan27:5015528,EPI_ISL_479799|Japan/PG-0015/2020|Jan20:5015528,EPI_ISL_403930|Wuhan/IPBCAMS-WH-03/2019|Dec30:5015528,(EPI_ISL_413015|Canada/ON_VIDO-01/2020|Jan23:5015528)19A#:5015528,((EPI_ISL_476139|Sweden/20-02114/2020|Jan31:5015528,EPI_ISL_451376|Sichuan/SC-WCH1-005/2020|Jan28:5015528,EPI_ISL_447919|Thailand/Samutprakarn_840/2020|Feb4:5015528,((EPI_ISL_406844|Australia/VIC01/2020|Jan25:5015528)19A#G26144T$T19065C+T22303G:5015528,EPI_ISL_522105|Australia/VIC2387/2020|Jun29:5015528)19A#G26144T$T19065C+T22303G:5015528,((EPI_ISL_418815|HongKong/HKPU36-0702/2020|Feb9:5015528,EPI_ISL_497771|HongKong/HKU-200723-004/2020|Jan29:5015528)19A#G26144T$T13929C:5015528,(EPI_ISL_411220|France/IDF-0386-islP3/2020|Jan28:5015528,((EPI_ISL_410545|Italy/LAZ-INMI1-isl/2020|Jan29:5015528)19A#G26144T:5015528,EPI_ISL_416411|Australia/VIC03/2020|Jan25:5015528)19A#G26144T:5015528)19A#G26144T:5015528)19A#G26144T:5015528)19A#G26144T:5015528,((EPI_ISL_410301|Nepal/61/2020|Jan13:5015528,(EPI_ISL_409067|USA/MA1/2020|Jan29:5015528)19A#C24034T:5015528)19A#C24034T:5015528,(EPI_ISL_402125|Wuhan/Hu-1/2019|Dec26:5015528,(((EPI_ISL_603108|Lithuania/MR-LUHS-Eilnr93/2020|Apr18:5015528,EPI_ISL_418799|Australia/QLDID922/2020|Feb28:5015528)19A#C15324T+T21644C+C29303T:5015528,((EPI_ISL_411902|Cambodia/0012/2020|Jan27:5015528,EPI_ISL_418269|Vietnam/19-01S/2020|Jan22:5015528)19A#:5015528,(EPI_ISL_428489|Taiwan/5/2020|Jan31:5015528,(((EPI_ISL_404253|USA/IL1/2020|Jan21:5015528)19A#:5015528,((EPI_ISL_407079|Finland/1/2020|Jan29:5015528)19A#:5015528,(EPI_ISL_417482|Ecuador/HEE-01/2020|Mar9:5015528,(EPI_ISL_413581|Netherlands/Oss_1363500/2020|Feb29:5015528,(EPI_ISL_523084|mink/Netherlands/NB-EMC-25-12/2020|Jul26:5015528,EPI_ISL_417211|NewZealand/CoV001/2020|Mar11:5015528)19A#T514C:5015528)19A#T514C:5015528)19A#T514C:5015528)19A#:5015528)19A#:5015528,((EPI_ISL_574608|Indonesia/JK-EIJK20/2020|Apr9:5015528,((EPI_ISL_408670|USA/WI1/2020|Jan31:5015528)19A#C17373T:5015528,EPI_ISL_419734|Australia/VIC14/2020|Feb2:5015528)19A#C17373T:5015528)19A#:5015528,(((EPI_ISL_547453|Curacao/CW-RIVM-10100/2020|Mar12:5015528,(EPI_ISL_636493|Curacao/CW-RIVM-10309/2020|Mar10:5015528,EPI_ISL_547451|Curacao/CW-RIVM-10093/2020|Mar10:5015528,(EPI_ISL_547450|Curacao/CW-RIVM-10092/2020|Mar10:5015528,EPI_ISL_547452|Curacao/CW-RIVM-10094/2020|Mar10:5015528)19A#T1606C$G29032A:5015528)19A#T1606C$G29032A:5015528)19A#T1606C:5015528,(EPI_ISL_424875|USA/NE_7025/2020|Mar7:5015528,EPI_ISL_414497|Germany/NW-HHU-02-1/2020|Feb25:5015528,(EPI_ISL_480298|Bulgaria/15/2020|May13:5015528,(EPI_ISL_497818|HongKong/HKU-200723-051/2020|Apr1:5015528,EPI_ISL_456164|NewZealand/20VR0759/2020|Mar18:5015528)19A#G1440A+G2891A$C10507T:5015528)19A#G1440A+G2891A:5015528)19A#G1440A+G2891A:5015528)19A#:5015528,(EPI_ISL_455385|Wuhan/HB-WH4-193/2020|Feb7:5015528,((EPI_ISL_515909|USA/CA-CDPH016/2020|Feb28:5015528,(EPI_ISL_427643|Australia/NSW219/2020|Feb28:5015528,EPI_ISL_413596|Australia/NSW10/2020|Feb28:5015528)19A#G25323T:5015528)19A#:5015528,((EPI_ISL_538512|Indonesia/PA-NIHRD-PME4306/2020|Jul30:5015528,EPI_ISL_451958|Pakistan/KHI1/2020|Mar16:5015528)19A#:5015528,((EPI_ISL_437058|USA/CA-CZB-1058/2020|Apr6:5015528,EPI_ISL_468589|USA/OK-QDX-93/2020|Mar13:5015528)19A#:5015528,((EPI_ISL_437190|Indonesia/JK-EIJK-02/2020|Mar26:5015528,EPI_ISL_430441|Malaysia/IMR_WC1097/2020|Feb29:5015528)19A#:5015528,((EPI_ISL_548984|Singapore/976/2020|Mar15:5015528,EPI_ISL_614252|USA/WY-UNM-00134/2020|Jun6:5015528)19A#:5015528,(EPI_ISL_455435|Mexico/JAL-InDRE-11/2020|Mar20:5015528,EPI_ISL_572053|USA/WV-QDX-1284/2020|Mar17:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528,(((EPI_ISL_468039|Australia/SAP097/2020|Feb22:5015528,(EPI_ISL_420456|Australia/WA11/2020|Feb22:5015528,EPI_ISL_470851|Australia/WA34/2020|Feb27:5015528)19A#G11083T$C9333T+C11671T:5015528)19A#G11083T:5015528,((EPI_ISL_419211|Israel/ISR_JP0320/2020|Feb23:5015528,EPI_ISL_454910|Wuhan/HB-WH1-131/2020|Mar2:5015528)19A#G11083T:5015528,(EPI_ISL_416631|Japan/DP0804/2020|Feb17:5015528,EPI_ISL_420796|USA/TX_2039/2020|Feb29:5015528)19A#G11083T:5015528)19A#G11083T:5015528)19A#G11083T:5015528,(EPI_ISL_525474|SriLanka/CDR142/2020|Apr19:5015528,EPI_ISL_420142|Georgia/Tb-1523/2020|Mar30:5015528,EPI_ISL_593737|Australia/NSW1123/2020|Sep13:5015528,((EPI_ISL_414476|USA/NY1-PV08001/2020|Feb29:5015528)19A#G11083T$G1397A+T28688C+G29742T$A9514G:5015528,(EPI_ISL_415577|Canada/BC_69243/2020|Feb20:5015528)19A#G11083T$G1397A+T28688C+G29742T$A9514G:5015528,(EPI_ISL_463002|Tunisia/COV0880/2020|Mar28:5015528,EPI_ISL_418832|Canada/BC_5282984/2020|Mar11:5015528)19A#G11083T$G1397A+T28688C+G29742T$A9514G$C228T+G9479T+G26720C+T28835C:5015528)19A#G11083T$G1397A+T28688C+G29742T$A9514G:5015528,(EPI_ISL_525479|SriLanka/CDR503/2020|Mar31:5015528,EPI_ISL_415644|Georgia/Tb-82/2020|Feb28:5015528,EPI_ISL_457704|Oman/RESP-20-837/2020|Feb24:5015528,EPI_ISL_637099|Iran/Q100/2020|Mar10:5015528,EPI_ISL_525481|SriLanka/CDR-SL7066/2020|Jun16:5015528,((EPI_ISL_450747|Canada/ON_SHSC-01/2020|Feb26:5015528)19A#G11083T$G1397A+T28688C+G29742T$C884T+G8653T:5015528,EPI_ISL_454589|Kazakhstan/26508/2020|Apr26:5015528)19A#G11083T$G1397A+T28688C+G29742T$C884T+G8653T:5015528)19A#G11083T$G1397A+T28688C+G29742T$C884T+G8653T:5015528,((EPI_ISL_414414|Australia/QLD09/2020|Feb29:5015528,(EPI_ISL_416542|Kuwait/KU17/2020|Mar2:5015528,EPI_ISL_475547|Sweden/20-04852/2020|Feb28:5015528)19A#G11083T$G1397A+T28688C+G29742T$G14653A:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528,((EPI_ISL_435131|UnitedArabEmirates/L2409/2020|Feb25:5015528,EPI_ISL_594187|Iran/2024/2020|Apr11:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528,((EPI_ISL_413490|NewZealand/20VR0174/2020|Feb27:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528,EPI_ISL_483556|Bahrein/BAH-15/2020|Apr4:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528)19A#G11083T$G1397A+T28688C+G29742T:5015528,(EPI_ISL_417765|Iceland/13/2020|Feb27:5015528,EPI_ISL_457730|Taiwan/TSGH-36/2020|Feb6:5015528,(EPI_ISL_654182|Spain/MD-IBV-99008611/2020|Jul27:5015528,EPI_ISL_654172|Spain/MD-IBV-99008612/2020|Aug6:5015528)19A#G11083T$G26144T$C4776T+T5406C+C7239T+C9438T+C12068T+C12974T+C14520T+T15835C+C19944T+T20427G+T21752A+T22076G+G24193C+G24751A+T27634C+G28198C:5015528,((EPI_ISL_417212|NewZealand/CoV002/2020|Mar11:5015528,(EPI_ISL_456236|NewZealand/20VR1626/2020|Mar23:5015528,EPI_ISL_456205|NewZealand/20VR1280/2020|Mar20:5015528)19A#G11083T$G26144T$C14805T$G13627T+C15540T+A28338G$C3096T+C12781T+G17944T+A29731G:5015528)19A#G11083T$G26144T$C14805T$G13627T+C15540T+A28338G:5015528,(EPI_ISL_471425|SouthKorea/KCDC2020/2020|Feb18:5015528,((EPI_ISL_418243|Spain/AN-ISCIII-201272/2020|Feb28:5015528,EPI_ISL_456378|NewZealand/20VR2109/2020|Apr15:5015528)19A#G11083T$G26144T$C14805T$C23707T:5015528,(EPI_ISL_482345|USA/OR-PROV-066/2020|Apr12:5015528,EPI_ISL_450186|Jordan/SR-0333/2020|Apr7:5015528)19A#G11083T$G26144T$C14805T:5015528)19A#G11083T$G26144T$C14805T:5015528)19A#G11083T$G26144T$C14805T:5015528,(EPI_ISL_516798|HongKong/HKU-200823-001/2020|Mar26:5015528,(EPI_ISL_413016|Brazil/SP-02/2020|Feb28:5015528)19A#G11083T$G26144T$C14805T$T17247C:5015528,((EPI_ISL_456600|Timor-Leste/TL25/2020|Mar30:5015528,EPI_ISL_456301|NewZealand/20VR1900/2020|Apr4:5015528)19A#G11083T$G26144T$C14805T$T17247C$A7479G+C25572T+C28887T:5015528,(EPI_ISL_547890|Peru/UN-INS-065/2020|Mar16:5015528,EPI_ISL_457959|Uruguay/UY-NYUMC863/2020|Mar26:5015528)19A#G11083T$G26144T$C14805T$T17247C:5015528)19A#G11083T$G26144T$C14805T$T17247C:5015528)19A#G11083T$G26144T$C14805T$T17247C:5015528,(EPI_ISL_437359|Germany/BY-MVP-0001/2020|Mar14:5015528,EPI_ISL_415128|Brazil/ES-225/2020|Feb29:5015528,(EPI_ISL_571261|USA/AR-QDX-532/2020|Mar18:5015528,(EPI_ISL_547449|Aruba/AW-RIVM-10122/2020|Mar22:5015528,EPI_ISL_547445|Aruba/AW-RIVM-10101/2020|Mar13:5015528)19A#G11083T$G26144T$C14805T$A2480G+C2558T$C9170T:5015528)19A#G11083T$G26144T$C14805T$A2480G+C2558T$C9170T:5015528,(EPI_ISL_455412|Nigeria/OG007-CV22/2020|Mar29:5015528,(EPI_ISL_427729|Australia/NSW77/2020|Mar17:5015528,EPI_ISL_420878|Australia/QLDID929/2020|Mar24:5015528)19A#G11083T$G26144T$C14805T$A2480G+C2558T:5015528)19A#G11083T$G26144T$C14805T$A2480G+C2558T:5015528)19A#G11083T$G26144T$C14805T$A2480G+C2558T:5015528)19A#G11083T$G26144T$C14805T:5015528)19A#G11083T$G26144T:5015528,(EPI_ISL_610162|Indonesia/JT-UGM-47964/2020|Aug31:5015528,EPI_ISL_632908|Pakistan/KP-RMI-01/2020|Apr1:5015528,EPI_ISL_622799|NewZealand/20CV0306/2020|Mar30:5015528,EPI_ISL_434556|Philippines/PGC04/2020|Mar26:5015528,(EPI_ISL_435674|Brunei/2/2020|Mar11:5015528,(EPI_ISL_528742|Malaysia/MGI-M76/2020|Apr2:5015528,(EPI_ISL_512844|Myanmar/MMC_137/2020|Apr22:5015528,((EPI_ISL_528743|Malaysia/MGI-MAEPS54/2020|Jun4:5015528,((EPI_ISL_428856|Gambia/GC19-026/2020|Mar21:5015528,EPI_ISL_501224|Malaysia/8816/2020|Mar18:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528,((EPI_ISL_435098|India/UN-NCDC-02240/2020|Mar28:5015528,EPI_ISL_480556|Senegal/1351/2020|Mar28:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528,(EPI_ISL_444999|Guam/GU_NHG_02/2020|Mar24:5015528,EPI_ISL_444610|Guam/GU-NHG-02/2020|Mar24:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528,(EPI_ISL_456611|Timor-Leste/TL23/2020|Apr18:5015528,(EPI_ISL_469091|Singapore/337/2020|Apr17:5015528,(EPI_ISL_518003|Singapore/839/2020|Jul26:5015528,(EPI_ISL_583899|Singapore/1064/2020|Aug17:5015528,(EPI_ISL_583900|Singapore/1065/2020|Aug17:5015528,EPI_ISL_583897|Singapore/1062/2020|Aug17:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T$A1846C+C4586T+G11291A+T19956C+C25546T+T26957C:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T$A1846C+C4586T+G11291A+T19956C+C25546T+T26957C:5015528,(EPI_ISL_483582|Singapore/559/2020|Jun19:5015528,(EPI_ISL_509384|Singapore/774/2020|Jul14:5015528,(EPI_ISL_516817|Singapore/817/2020|Aug11:5015528,(EPI_ISL_527378|Singapore/869/2020|Aug25:5015528,EPI_ISL_518002|Singapore/838/2020|Jul26:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T$A3951G:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T$A3951G:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T$A3951G:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T$A3951G:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$G9500A+T16542C+G17427T+C18894T+G29616T:5015528,((EPI_ISL_516810|Singapore/810/2020|Aug11:5015528,(EPI_ISL_518001|Singapore/837/2020|Jul29:5015528,((EPI_ISL_479589|Singapore/511/2020|May22:5015528,EPI_ISL_512831|Singapore/795/2020|Jul26:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C28957T:5015528,(EPI_ISL_536420|Singapore/879/2020|Aug29:5015528,(EPI_ISL_645116|Singapore/1389/2020|Sep16:5015528,EPI_ISL_536432|Singapore/891/2020|Sep6:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$T2029A+A3061G+C7851T+G10496A:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$T2029A+A3061G+C7851T+G10496A:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A:5015528,((EPI_ISL_596476|Singapore/1086/2020|Aug5:5015528,EPI_ISL_648741|Singapore/1387/2020|Jul26:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T$G15006T+C25308A:5015528,(EPI_ISL_527369|Singapore/860/2020|Aug18:5015528,((EPI_ISL_536431|Singapore/890/2020|Sep3:5015528,EPI_ISL_536451|Singapore/910/2020|Sep3:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T$C1912T+C2695T+G20679T+G26152A+A27663G$C24748T:5015528,(EPI_ISL_527361|Singapore/852/2020|Aug20:5015528,(EPI_ISL_583894|Singapore/1059/2020|Aug29:5015528,EPI_ISL_536418|Singapore/877/2020|Aug28:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T$C1912T+C2695T+G20679T+G26152A+A27663G$G17427T+G28079T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T$C1912T+C2695T+G20679T+G26152A+A27663G$G17427T+G28079T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T$C1912T+C2695T+G20679T+G26152A+A27663G:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A$C23185T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T$C6310A:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T$C19524T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T$C6312A+C13730T+C23929T+C28311T:5015528)19A#G11083T:5015528)19A#:5015528)19A#:5015528)19A#:5015528)19A#:5015528,(EPI_ISL_477170|Singapore/470/2020|Feb16:5015528)19A#C8782T:5015528,((EPI_ISL_480780|Australia/SA03/2020|Jan30:5015528,EPI_ISL_480781|Australia/SA04/2020|Jan30:5015528)19A#C3037T$C17074T+C27213T+T27384C:5015528,(EPI_ISL_450209|Germany/BY-ChVir-1017/2020|Jan30:5015528)19A#C3037T$C241T+A23403G:5015528)19A#C3037T:5015528)19A#:5015528;'

const temptreeSeq = `CLUSTAL O(1.2.3) multiple sequence alignment
UniProt/Swiss-Prot|P26898|IL2RA_SHEEP      MEPSLLMWRFFVFIVVPGCVTEACHDDPPSLRNA----------MFKVLRYE----VGTM
UniProt/Swiss-Prot|P01590|IL2RA_MOUSE      MEPRLLMLGFLSLTIVPSCRAELCLYDPPEVPNA----------TFKALSYK----NGTI
UniProt/Swiss-Prot|P41690|IL2RA_FELCA      MEPSLLLWGILTFVVVHGHVTELCDENPPDIQHA----------TFKALTYK----TGTM
UniProt/Swiss-Prot|P01589|IL2RA_HUMAN      MDSYLLMWGLLTFIMVPGCQAELCDDDPPEIPHA----------TFKAMAYK----EGTM
UniProt/Swiss-Prot|Q5MNY4|IL2RA_MACMU      MDPYLLMWGLLTFITVPGCQAELCDDDPPKITHA----------TFKAVAYK----EGTM
UniProt/Swiss-Prot|Q95118|IL2RG_BOVIN      -----------------------------------LLMWGLLT-----------------
UniProt/Swiss-Prot|P40321|IL2RG_CANFA      MLKPPLPLRSLLFLQLSLLGVGLNSTVPMPNGNEDIT------PDFFLTATPSETLSVSS
UniProt/Swiss-Prot|P26896|IL2RB_RAT        MATVDLSWRLPLYILLLLLATT--------------------------------WVSAAV
UniProt/Swiss-Prot|Q8BZM1|GLMN_MOUSE       PLPLRSLLFLQLPLLGVGLNP------------------PLPLRSLLFLQLPLLGVGLNP
UniProt/Swiss-Prot|P36835|IL2_CAPHI        -----------LLGVGLNPKFLTP------------------------------------
UniProt/Swiss-Prot|Q7JFM4|IL2_AOTVO        MLKPPLPLRSLLFLQLPLLGVGLNPKFLTPSGNEDIGGKPGTGGDFFLTSTPAGTLDVST
UniProt/Swiss-Prot|Q29416|IL2_CANFA        --------------LFLQLSLLG-------------------------------------
`
export default function stateModelFactory(pluginManager: PluginManager) {
  return types.compose(
    BaseViewModel,
    types
      .model('MsaView', {
        id: ElementId,
        type: types.literal('MsaView'),
        height: 600,
        treeWidth: 100,
        // todo: make this from adapter
        data: types.optional(types.string, temptreeSeq),
        // todo: make this an object? or adapter?
        treeData: types.optional(types.string, temptree),
      })
      .volatile(() => ({
        error: undefined as Error | undefined,
        volatileWidth: 0,
        drawn: false,
        margin: { left: 20, top: 20 },
      }))
      .actions(self => ({
        setError(error?: Error) {
          self.error = error
        },

        setData(text: string) {
          self.data = text
        },
        setWidth(width: number) {
          self.volatileWidth = width
        },
        setDrawn(flag: boolean) {
          self.drawn = flag
        },
      }))
      .views(self => ({
        get initialized() {
          return self.volatileWidth > 0 && Boolean(self.data)
        },
        get menuItems() {
          return []
        },

        get msa() {
          return self.data && parse(self.data)
        },
        get width() {
          return self.volatileWidth
        },

        get newickTree() {
          return parseNewick(self.treeData)
        },

        get root() {
          const root = d3
            .hierarchy(this.newickTree, d => d.branchset)
            .sum(d => (d.branchset ? 0 : 1))
            .sort(
              (a, b) =>
                a.value - b.value || d3.ascending(a.data.length, b.data.length),
            )

          return root
        },

        get tree() {
          const cluster = d3
            .cluster()
            .size([this.totalHeight, self.treeWidth])
            .separation((a, b) => 1)
          cluster(this.root)
          return this.root
        },

        get nodePositions() {
          return this.tree.leaves().map(d => {
            return { name: d.data.name, x: d.x, y: d.y }
          })
        },

        get totalHeight() {
          return this.root.leaves().length * 20
        },
      })),
  )
}

export type MsaViewStateModel = ReturnType<typeof stateModelFactory>
export type MsaViewModel = Instance<MsaViewStateModel>
